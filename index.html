<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

    <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-4xl text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Google Sheets Data Search</h1>
        <p class="text-lg text-gray-600 mb-6">
            Paste a public Google Sheet CSV URL below to search its contents. The URL will be saved automatically for your next visit.
        </p>

        <!-- Input and Search Button Container -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
            <input type="text" id="csvUrl" placeholder="Paste your Google Sheet's public CSV URL here..."
                   class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
            <button id="searchButton"
                    class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all transform hover:scale-105">
                Search Sheet
            </button>
        </div>

        <!-- Search Results Section -->
        <div class="search-section w-full">
            <!-- Search input and results container -->
            <div class="mb-4 text-left">
                <input type="text" id="searchInput" placeholder="Search data..."
                       class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
            </div>

            <!-- Loading and Error Messages -->
            <div id="statusMessage" class="text-center text-gray-600 mb-4"></div>

            <!-- Results Table -->
            <div id="resultsTable" class="hidden overflow-x-auto rounded-lg shadow-inner bg-gray-50">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr id="tableHeader" class="text-sm font-medium text-gray-600 uppercase tracking-wider text-left"></tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200 text-gray-700 text-sm"></tbody>
                </table>
            </div>

            <p id="noResults" class="hidden text-center text-gray-500 mt-4">No results found.</p>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById('csvUrl');
        const searchButton = document.getElementById('searchButton');
        const searchInput = document.getElementById('searchInput');
        const statusMessage = document.getElementById('statusMessage');
        const resultsTable = document.getElementById('resultsTable');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const noResultsMessage = document.getElementById('noResults');

        let allData = [];

        // Function to save URL to local storage
        function saveUrlToLocalStorage(url) {
            localStorage.setItem('googleSheetUrl', url);
        }

        // Function to load URL from local storage
        function loadUrlFromLocalStorage() {
            return localStorage.getItem('googleSheetUrl');
        }

        // Load URL from local storage on page load
        const savedUrl = loadUrlFromLocalStorage();
        if (savedUrl) {
            urlInput.value = savedUrl;
        }

        // Event listener to save URL whenever the input changes
        urlInput.addEventListener('input', (e) => {
            saveUrlToLocalStorage(e.target.value);
        });

        searchButton.addEventListener('click', fetchData);
        searchInput.addEventListener('input', filterData);

        // Function to fetch and process CSV data
        async function fetchData() {
            const url = urlInput.value.trim();
            if (!url) {
                statusMessage.textContent = 'Please enter a valid CSV URL.';
                resultsTable.classList.add('hidden');
                noResultsMessage.classList.add('hidden');
                return;
            }

            statusMessage.textContent = 'Fetching data...';
            resultsTable.classList.add('hidden');
            noResultsMessage.classList.add('hidden');
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                parseCSV(text);
                statusMessage.textContent = `Data loaded successfully from ${url}.`;
                searchInput.value = ''; // Clear search input on new data load
                filterData();
            } catch (error) {
                statusMessage.textContent = `Error: Unable to fetch data. Please check the URL.`;
                console.error('Fetch error:', error);
                resultsTable.classList.add('hidden');
            }
        }

        // Function to parse CSV data
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = lines.slice(1).map(line => {
                const values = line.split(',').map(value => value.trim().replace(/"/g, ''));
                let row = {};
                headers.forEach((header, i) => {
                    row[header] = values[i];
                });
                return row;
            });
            allData = data;
            renderTable(allData, headers);
        }

        // Function to render the HTML table
        function renderTable(data, headers) {
            tableHeader.innerHTML = headers.map(header => `<th class="p-4">${header}</th>`).join('');
            tableBody.innerHTML = data.map(row => {
                const cells = headers.map(header => `<td class="p-4 whitespace-nowrap">${row[header] || ''}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
            
            if (data.length > 0) {
                resultsTable.classList.remove('hidden');
                noResultsMessage.classList.add('hidden');
            } else {
                resultsTable.classList.add('hidden');
                noResultsMessage.classList.remove('hidden');
            }
        }

        // Function to filter data based on search input
        function filterData() {
            const query = searchInput.value.toLowerCase();
            const filteredData = allData.filter(row => {
                return Object.values(row).some(value => 
                    value.toLowerCase().includes(query)
                );
            });
            const headers = allData.length > 0 ? Object.keys(allData[0]) : [];
            renderTable(filteredData, headers);
        }

        // Initial fetch if a URL is already present in local storage
        if (savedUrl) {
            fetchData();
        }
    </script>
</body>
</html>
